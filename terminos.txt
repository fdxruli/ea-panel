Bienvenido a Entre Alas. Al acceder y utilizar nuestra aplicaci√≥n web (en adelante, la "Plataforma") para realizar pedidos, aceptas cumplir y estar sujeto a los siguientes t√©rminos y condiciones (en adelante, los "T√©rminos"). Por favor, l√©elos atentamente. Si no est√°s de acuerdo con estos T√©rminos, no deber√°s utilizar la Plataforma.

1. Definiciones

"Nosotros", "Nuestro", "Entre Alas": Se refiere al propietario y operador de la Plataforma.

"T√∫", "Usuario", "Cliente": Se refiere a cualquier persona que acceda o utilice la Plataforma.

"Plataforma": Se refiere a la aplicaci√≥n web de Entre Alas accesible a trav√©s de navegadores web.

"Servicio": Se refiere a la posibilidad de ver el men√∫, realizar pedidos de alimentos y bebidas, gestionar tu cuenta y participar en programas ofrecidos a trav√©s de la Plataforma.

2. Registro y Cuenta de Usuario

Registro: Para utilizar ciertas funciones, como realizar pedidos y acceder a tu historial, deber√°s registrarte utilizando tu n√∫mero de tel√©fono de WhatsApp v√°lido (10 d√≠gitos) y proporcionar tu nombre completo. Eres responsable de mantener la confidencialidad de tu n√∫mero y de todas las actividades que ocurran bajo tu cuenta.

Aceptaci√≥n de T√©rminos: Al registrarte o ingresar tu n√∫mero por primera vez, se te pedir√° que leas y aceptes estos T√©rminos y Condiciones. Tu uso continuado de la Plataforma despu√©s de cualquier modificaci√≥n de los T√©rminos constituir√° tu aceptaci√≥n de dichos cambios.

Informaci√≥n Veraz: Te comprometes a proporcionar informaci√≥n verdadera, precisa, actual y completa durante el registro y a mantenerla actualizada.

Uso Personal: Tu cuenta es para uso personal e intransferible.

3. Uso de la Plataforma y Pedidos

Elegibilidad: Debes tener la edad legal para formar un contrato vinculante en tu jurisdicci√≥n para usar la Plataforma.

Men√∫ y Precios: Mostramos nuestro men√∫ de productos con sus precios. Nos esforzamos por mantener la informaci√≥n actualizada, pero los precios y la disponibilidad de los productos est√°n sujetos a cambios sin previo aviso. Pueden aplicarse precios especiales o descuentos bajo ciertas condiciones (ej. promociones, clientes espec√≠ficos, programas de referidos).

Realizaci√≥n de Pedidos: Puedes seleccionar productos, a√±adirlos a tu carrito y proceder a la confirmaci√≥n del pedido. Al confirmar tu pedido, ser√°s redirigido a WhatsApp para finalizar el proceso y enviar tu solicitud. Tu pedido se considera realizado una vez enviado el mensaje de confirmaci√≥n por WhatsApp.

Horario de Servicio: Los pedidos solo pueden realizarse y ser√°n procesados durante nuestro horario de atenci√≥n publicado, sujeto a excepciones. Intentar realizar un pedido fuera de horario puede no ser posible.

Zona de Reparto: Nuestro servicio de entrega est√° limitado a una zona geogr√°fica espec√≠fica, la cual se indica visualmente mediante un mapa durante el proceso de selecci√≥n de direcci√≥n. Nos reservamos el derecho de rechazar pedidos fuera de esta zona.

Direcci√≥n de Entrega: Eres responsable de proporcionar una direcci√≥n de entrega precisa y completa, incluyendo referencias si son necesarias. Puedes guardar m√∫ltiples direcciones y seleccionar una predeterminada. La ubicaci√≥n se confirma mediante un mapa interactivo.

Pedidos Programados: Ofrecemos la opci√≥n de programar pedidos para una fecha y hora futuras espec√≠ficas dentro de nuestro horario operativo. Haremos lo posible por cumplir con la hora programada, pero est√° sujeta a disponibilidad y posibles retrasos imprevistos.

Pago: (Asunci√≥n: Pago contra entrega) El pago de tu pedido se realizar√° al momento de la entrega en efectivo o con tarjeta, seg√∫n las opciones disponibles y comunicadas por el repartidor. El total a pagar incluir√° el costo de los productos y cualquier cargo aplicable por entrega (si lo hubiera).

Confirmaci√≥n y Seguimiento: Recibir√°s confirmaci√≥n de tu pedido v√≠a WhatsApp. Podr√°s ver el estado de tus pedidos activos ("pendiente", "en proceso", "en env√≠o") y tu historial de pedidos ("completado", "cancelado") en la secci√≥n "Mis Pedidos" de la Plataforma.

4. Modificaciones y Cancelaciones de Pedidos

Modificaci√≥n por el Cliente: Puedes editar los productos de tu pedido √∫nicamente si su estado es "pendiente" a trav√©s de la secci√≥n "Mis Pedidos".

Cancelaci√≥n por el Cliente:

Si el pedido est√° en estado "pendiente", puedes cancelarlo directamente desde la Plataforma.

Si el pedido est√° "en proceso", la cancelaci√≥n autom√°tica no es posible. Deber√°s solicitar la cancelaci√≥n enviando un mensaje a nuestro n√∫mero de WhatsApp a trav√©s de la opci√≥n proporcionada en la Plataforma, indicando el motivo. La aceptaci√≥n de esta solicitud queda a nuestra discreci√≥n dependiendo del avance de la preparaci√≥n.

Los pedidos en estado "en env√≠o", "completado" o "cancelado" no pueden ser modificados ni cancelados por el cliente.

Cancelaci√≥n por Entre Alas: Nos reservamos el derecho de cancelar un pedido en cualquier momento por razones como falta de disponibilidad de productos, imposibilidad de entrega en la direcci√≥n indicada, condiciones clim√°ticas adversas, sospecha de fraude o incumplimiento de estos T√©rminos. Te notificaremos en caso de cancelaci√≥n por nuestra parte.

5. Descuentos y Promociones

Podemos ofrecer c√≥digos de descuento o promociones. Estos est√°n sujetos a t√©rminos espec√≠ficos (fechas de validez, aplicabilidad a productos/categor√≠as, uso √∫nico, etc.).

Para aplicar un descuento, debes ingresar el c√≥digo v√°lido en el carrito antes de confirmar el pedido.

Algunos c√≥digos pueden ser de un solo uso por cliente. El uso indebido de c√≥digos de descuento puede resultar en la cancelaci√≥n del pedido o la desactivaci√≥n de la cuenta.

Los descuentos de bienvenida o por referidos pueden tener condiciones especiales, como ser aplicables solo a clientes nuevos o referidos.

6. Programa de Referidos

Los clientes registrados pueden obtener un c√≥digo de referido √∫nico para invitar a nuevos usuarios.

Cuando un nuevo usuario se registra utilizando un c√≥digo de referido v√°lido, el referente puede acumular referidos.

Podemos ofrecer recompensas basadas en la cantidad de referidos acumulados, organizadas por niveles. Los detalles, niveles y recompensas del programa est√°n sujetos a cambios a nuestra discreci√≥n.

Las recompensas pueden consistir en descripciones o c√≥digos de descuento espec√≠ficos. Los c√≥digos de recompensa pueden tener condiciones de uso (ej. un solo uso, aplicabilidad).

Nos reservamos el derecho de invalidar referidos o recompensas en caso de detectar fraude o abuso del sistema.

7. Contenido Generado por el Usuario (Rese√±as y Favoritos)

Puedes marcar productos como favoritos y escribir rese√±as (calificaci√≥n y comentario) sobre los productos que has pedido.

Al enviar una rese√±a, nos otorgas una licencia mundial, no exclusiva, libre de regal√≠as, para usar, reproducir, modificar y mostrar tu rese√±a en conexi√≥n con la Plataforma y la promoci√≥n de nuestros productos.

Eres responsable del contenido de tus rese√±as. No deben contener lenguaje ofensivo, difamatorio, ilegal o inapropiado.

Nos reservamos el derecho de moderar o eliminar rese√±as que violen estos T√©rminos o que consideremos inapropiadas, sin previo aviso.

Puedes gestionar tus favoritos y rese√±as desde la secci√≥n "Mi Actividad".

8. Privacidad y Datos Personales

Recopilamos y utilizamos tu informaci√≥n personal (nombre, n√∫mero de tel√©fono, direcciones, historial de pedidos, favoritos, rese√±as) para operar la Plataforma, procesar tus pedidos, mejorar nuestro servicio y comunicarnos contigo.

Utilizamos tu n√∫mero de WhatsApp como identificador principal y para comunicaciones relacionadas con tus pedidos y el servicio.

Podemos utilizar cookies o tecnolog√≠as similares para el funcionamiento de la Plataforma y mejorar tu experiencia.

9. Comunicaci√≥n

Al registrarte, aceptas recibir comunicaciones de nuestra parte a trav√©s de WhatsApp relacionadas con tus pedidos (confirmaciones, actualizaciones, solicitudes de cancelaci√≥n) y potencialmente otras notificaciones sobre el servicio o promociones.

Si tu navegador lo permite y otorgas permiso, podr√≠amos enviarte notificaciones push sobre actualizaciones importantes o promociones. Puedes gestionar estos permisos en la configuraci√≥n de tu navegador o dispositivo.

10. Propiedad Intelectual

Todo el contenido de la Plataforma, incluyendo textos, gr√°ficos, logos, im√°genes y software, es propiedad de Entre Alas o sus licenciantes y est√° protegido por las leyes de propiedad intelectual. No puedes copiar, modificar, distribuir o utilizar dicho contenido sin nuestro permiso expl√≠cito por escrito.

11. Limitaci√≥n de Responsabilidad y Descargos de Garant√≠a

La Plataforma se proporciona "tal cual" y "seg√∫n disponibilidad". No garantizamos que la Plataforma est√© libre de errores o interrupciones.

Alergias e Intolerancias: Es tu responsabilidad informarnos sobre cualquier alergia o intolerancia alimentaria al momento de realizar tu pedido (preferiblemente en el mensaje de confirmaci√≥n de WhatsApp, o contact√°ndonos directamente). Aunque tomamos precauciones, no podemos garantizar la ausencia total de al√©rgenos en nuestros productos o cocina. No nos hacemos responsables por reacciones al√©rgicas si no fuiste expl√≠cito sobre tus restricciones.

En la m√°xima medida permitida por la ley, Entre Alas no ser√° responsable por da√±os directos, indirectos, incidentales, especiales o consecuentes que resulten del uso o la imposibilidad de usar la Plataforma o el Servicio.

Nuestra responsabilidad total por cualquier reclamo relacionado con un pedido se limitar√° al monto pagado por dicho pedido.

12. Modificaciones a los T√©rminos

Nos reservamos el derecho de modificar estos T√©rminos en cualquier momento. Publicaremos los T√©rminos actualizados en la Plataforma. Se te podr√° solicitar que aceptes los nuevos t√©rminos para continuar utilizando el Servicio. Es tu responsabilidad revisar los T√©rminos peri√≥dicamente.

13. Contacto

Si tienes alguna pregunta sobre estos T√©rminos y Condiciones, por favor cont√°ctanos a trav√©s de 9631834700 o contacto.entrealas@gmail.com.


// supabase/functions/send-order-notification/index.ts
import { createClient } from 'npm:@supabase/supabase-js@2';
// === 1Ô∏è‚É£ Variables de entorno ===
const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
const FCM_SERVER_KEY = Deno.env.get('FCM_SERVER_KEY'); // üî• NUEVA CLAVE
if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY || !FCM_SERVER_KEY) {
  console.error('‚ùå Missing environment variables.');
  Deno.exit(1);
}
console.log('üöÄ Edge Function initialized: send-order-notification');
// === Funci√≥n para eliminar suscripci√≥n inv√°lida ===
async function deleteInvalidSubscription(supabase, endpoint) {
  console.warn(`üóëÔ∏è Deleting invalid subscription with endpoint: ${endpoint}`);
  const { error: deleteError } = await supabase.from('push_subscriptions').delete().eq('subscription_token->>endpoint', endpoint); // Usar el endpoint completo para asegurar unicidad
  if (deleteError) {
    console.error(`‚ùå Failed to delete subscription ${endpoint}:`, deleteError.message);
  } else {
    console.log(`‚úÖ Successfully deleted subscription ${endpoint}.`);
  }
}
// === 2Ô∏è‚É£ Funci√≥n principal ===
Deno.serve(async (req)=>{
  try {
    const payload = await req.json();
    console.log('üì¶ Received payload:', JSON.stringify(payload, null, 2));
    const order = payload.record;
    const oldOrder = payload.old_record;
    if (!order || !order.customer_id) {
      throw new Error('Invalid order data in payload.');
    }
    // Solo notificar si el estado cambi√≥ realmente
    if (oldOrder && order.status === oldOrder.status) {
      console.log(`‚ÑπÔ∏è Order ${order.order_code} status did not change. Skipping.`);
      return new Response('Status did not change', {
        status: 200
      });
    }
    console.log(`üîî Order ${order.order_code} status changed to ${order.status}. Fetching subscriptions...`);
    // Crear cliente Supabase dentro del handler
    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
    const { data: subscriptions, error } = await supabase.from('push_subscriptions').select('subscription_token') // Solo necesitamos el token
    .eq('customer_id', order.customer_id);
    if (error) throw error;
    if (!subscriptions || subscriptions.length === 0) {
      console.warn(`‚ö†Ô∏è No push subscriptions found for customer: ${order.customer_id}`);
      return new Response('No subscriptions found', {
        status: 200
      });
    }
    console.log(`‚úÖ Found ${subscriptions.length} subscription(s). Sending via FCM...`);
    // Mensajes seg√∫n estado
    const statusMessages = {
      en_proceso: 'Tu pedido est√° en proceso.',
      en_envio: '¬°Tu pedido ya va en camino!',
      completado: 'Tu pedido ha sido completado. ¬°Gracias por tu compra!',
      cancelado: 'Tu pedido ha sido cancelado.'
    };
    const notificationData = {
      title: `Actualizaci√≥n de pedido #${order.order_code}`,
      body: statusMessages[order.status] || `Estado: ${order.status}`
    };
    const dataPayload = {
      url: '/mis-pedidos' // URL a abrir al hacer clic
    };
    // === 3Ô∏è‚É£ Enviar notificaciones y manejar errores ===
    const sendPromises = subscriptions.map(async ({ subscription_token })=>{
      const endpoint = subscription_token?.endpoint; // Safely access endpoint
      const fcmToken = subscription_token?.keys?.auth; // O usa el campo correcto donde guardas el token si es diferente
      if (!endpoint || !fcmToken) {
        console.warn('‚ö†Ô∏è Invalid subscription object:', subscription_token);
        return; // Skip this subscription
      }
      try {
        const fcmResponse = await fetch('https://fcm.googleapis.com/fcm/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `key=${FCM_SERVER_KEY}`
          },
          body: JSON.stringify({
            to: fcmToken,
            notification: notificationData,
            data: dataPayload // Env√≠a datos adicionales aqu√≠
          })
        });
        // --- üëá MANEJO DE RESPUESTA DE FCM ---
        if (!fcmResponse.ok) {
          // Si la respuesta NO fue exitosa (ej. 404, 410, etc.)
          const status = fcmResponse.status;
          const responseText = await fcmResponse.text(); // Leer el cuerpo para logs
          console.error(`‚ùå FCM error for token ${fcmToken} (Endpoint: ${endpoint}) - Status: ${status}, Response: ${responseText}`);
          // Si el error es 404 (Not Found) o 410 (Gone), el token es inv√°lido
          if (status === 404 || status === 410) {
            await deleteInvalidSubscription(supabase, endpoint);
          }
        } else {
          // Si la respuesta fue exitosa (ej. 200 OK)
          const responseJson = await fcmResponse.json(); // FCM suele devolver JSON en √©xito
          console.log(`üì® FCM success for ${fcmToken} (Endpoint: ${endpoint}):`, JSON.stringify(responseJson));
        }
      // --- üëÜ FIN MANEJO DE RESPUESTA ---
      } catch (fetchError) {
        // Error al intentar contactar FCM (problema de red, etc.)
        console.error(`üí• Network or fetch error sending to ${endpoint}:`, fetchError.message);
      }
    });
    await Promise.all(sendPromises); // Esperar a que todos los env√≠os terminen
    console.log('‚úÖ Push notification sending process completed.');
    return new Response(JSON.stringify({
      success: true
    }), {
      headers: {
        'Content-Type': 'application/json'
      }
    });
  } catch (error) {
    console.error('üí• General Error in Edge Function:', error.message);
    return new Response(JSON.stringify({
      error: error.message
    }), {
      status: 500,
      headers: {
        'Content-Type': 'application/json'
      }
    });
  }
});


podemos hacer que en notificationManager.jsx inicialice el sdk de firebase asi no tendremos problemas en el futuro si queremos escalar la app