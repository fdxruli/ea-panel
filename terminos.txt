Bienvenido a Entre Alas. Al acceder y utilizar nuestra aplicaciÃ³n web (en adelante, la "Plataforma") para realizar pedidos, aceptas cumplir y estar sujeto a los siguientes tÃ©rminos y condiciones (en adelante, los "TÃ©rminos"). Por favor, lÃ©elos atentamente. Si no estÃ¡s de acuerdo con estos TÃ©rminos, no deberÃ¡s utilizar la Plataforma.

1. Definiciones

"Nosotros", "Nuestro", "Entre Alas": Se refiere al propietario y operador de la Plataforma.

"TÃº", "Usuario", "Cliente": Se refiere a cualquier persona que acceda o utilice la Plataforma.

"Plataforma": Se refiere a la aplicaciÃ³n web de Entre Alas accesible a travÃ©s de navegadores web.

"Servicio": Se refiere a la posibilidad de ver el menÃº, realizar pedidos de alimentos y bebidas, gestionar tu cuenta y participar en programas ofrecidos a travÃ©s de la Plataforma.

2. Registro y Cuenta de Usuario

Registro: Para utilizar ciertas funciones, como realizar pedidos y acceder a tu historial, deberÃ¡s registrarte utilizando tu nÃºmero de telÃ©fono de WhatsApp vÃ¡lido (10 dÃ­gitos) y proporcionar tu nombre completo. Eres responsable de mantener la confidencialidad de tu nÃºmero y de todas las actividades que ocurran bajo tu cuenta.

AceptaciÃ³n de TÃ©rminos: Al registrarte o ingresar tu nÃºmero por primera vez, se te pedirÃ¡ que leas y aceptes estos TÃ©rminos y Condiciones. Tu uso continuado de la Plataforma despuÃ©s de cualquier modificaciÃ³n de los TÃ©rminos constituirÃ¡ tu aceptaciÃ³n de dichos cambios.

InformaciÃ³n Veraz: Te comprometes a proporcionar informaciÃ³n verdadera, precisa, actual y completa durante el registro y a mantenerla actualizada.

Uso Personal: Tu cuenta es para uso personal e intransferible.

3. Uso de la Plataforma y Pedidos

Elegibilidad: Debes tener la edad legal para formar un contrato vinculante en tu jurisdicciÃ³n para usar la Plataforma.

MenÃº y Precios: Mostramos nuestro menÃº de productos con sus precios. Nos esforzamos por mantener la informaciÃ³n actualizada, pero los precios y la disponibilidad de los productos estÃ¡n sujetos a cambios sin previo aviso. Pueden aplicarse precios especiales o descuentos bajo ciertas condiciones (ej. promociones, clientes especÃ­ficos, programas de referidos).

RealizaciÃ³n de Pedidos: Puedes seleccionar productos, aÃ±adirlos a tu carrito y proceder a la confirmaciÃ³n del pedido. Al confirmar tu pedido, serÃ¡s redirigido a WhatsApp para finalizar el proceso y enviar tu solicitud. Tu pedido se considera realizado una vez enviado el mensaje de confirmaciÃ³n por WhatsApp.

Horario de Servicio: Los pedidos solo pueden realizarse y serÃ¡n procesados durante nuestro horario de atenciÃ³n publicado, sujeto a excepciones. Intentar realizar un pedido fuera de horario puede no ser posible.

Zona de Reparto: Nuestro servicio de entrega estÃ¡ limitado a una zona geogrÃ¡fica especÃ­fica, la cual se indica visualmente mediante un mapa durante el proceso de selecciÃ³n de direcciÃ³n. Nos reservamos el derecho de rechazar pedidos fuera de esta zona.

DirecciÃ³n de Entrega: Eres responsable de proporcionar una direcciÃ³n de entrega precisa y completa, incluyendo referencias si son necesarias. Puedes guardar mÃºltiples direcciones y seleccionar una predeterminada. La ubicaciÃ³n se confirma mediante un mapa interactivo.

Pedidos Programados: Ofrecemos la opciÃ³n de programar pedidos para una fecha y hora futuras especÃ­ficas dentro de nuestro horario operativo. Haremos lo posible por cumplir con la hora programada, pero estÃ¡ sujeta a disponibilidad y posibles retrasos imprevistos.

Pago: (AsunciÃ³n: Pago contra entrega) El pago de tu pedido se realizarÃ¡ al momento de la entrega en efectivo o con tarjeta, segÃºn las opciones disponibles y comunicadas por el repartidor. El total a pagar incluirÃ¡ el costo de los productos y cualquier cargo aplicable por entrega (si lo hubiera).

ConfirmaciÃ³n y Seguimiento: RecibirÃ¡s confirmaciÃ³n de tu pedido vÃ­a WhatsApp. PodrÃ¡s ver el estado de tus pedidos activos ("pendiente", "en proceso", "en envÃ­o") y tu historial de pedidos ("completado", "cancelado") en la secciÃ³n "Mis Pedidos" de la Plataforma.

4. Modificaciones y Cancelaciones de Pedidos

ModificaciÃ³n por el Cliente: Puedes editar los productos de tu pedido Ãºnicamente si su estado es "pendiente" a travÃ©s de la secciÃ³n "Mis Pedidos".

CancelaciÃ³n por el Cliente:

Si el pedido estÃ¡ en estado "pendiente", puedes cancelarlo directamente desde la Plataforma.

Si el pedido estÃ¡ "en proceso", la cancelaciÃ³n automÃ¡tica no es posible. DeberÃ¡s solicitar la cancelaciÃ³n enviando un mensaje a nuestro nÃºmero de WhatsApp a travÃ©s de la opciÃ³n proporcionada en la Plataforma, indicando el motivo. La aceptaciÃ³n de esta solicitud queda a nuestra discreciÃ³n dependiendo del avance de la preparaciÃ³n.

Los pedidos en estado "en envÃ­o", "completado" o "cancelado" no pueden ser modificados ni cancelados por el cliente.

CancelaciÃ³n por Entre Alas: Nos reservamos el derecho de cancelar un pedido en cualquier momento por razones como falta de disponibilidad de productos, imposibilidad de entrega en la direcciÃ³n indicada, condiciones climÃ¡ticas adversas, sospecha de fraude o incumplimiento de estos TÃ©rminos. Te notificaremos en caso de cancelaciÃ³n por nuestra parte.

5. Descuentos y Promociones

Podemos ofrecer cÃ³digos de descuento o promociones. Estos estÃ¡n sujetos a tÃ©rminos especÃ­ficos (fechas de validez, aplicabilidad a productos/categorÃ­as, uso Ãºnico, etc.).

Para aplicar un descuento, debes ingresar el cÃ³digo vÃ¡lido en el carrito antes de confirmar el pedido.

Algunos cÃ³digos pueden ser de un solo uso por cliente. El uso indebido de cÃ³digos de descuento puede resultar en la cancelaciÃ³n del pedido o la desactivaciÃ³n de la cuenta.

Los descuentos de bienvenida o por referidos pueden tener condiciones especiales, como ser aplicables solo a clientes nuevos o referidos.

6. Programa de Referidos

Los clientes registrados pueden obtener un cÃ³digo de referido Ãºnico para invitar a nuevos usuarios.

Cuando un nuevo usuario se registra utilizando un cÃ³digo de referido vÃ¡lido, el referente puede acumular referidos.

Podemos ofrecer recompensas basadas en la cantidad de referidos acumulados, organizadas por niveles. Los detalles, niveles y recompensas del programa estÃ¡n sujetos a cambios a nuestra discreciÃ³n.

Las recompensas pueden consistir en descripciones o cÃ³digos de descuento especÃ­ficos. Los cÃ³digos de recompensa pueden tener condiciones de uso (ej. un solo uso, aplicabilidad).

Nos reservamos el derecho de invalidar referidos o recompensas en caso de detectar fraude o abuso del sistema.

7. Contenido Generado por el Usuario (ReseÃ±as y Favoritos)

Puedes marcar productos como favoritos y escribir reseÃ±as (calificaciÃ³n y comentario) sobre los productos que has pedido.

Al enviar una reseÃ±a, nos otorgas una licencia mundial, no exclusiva, libre de regalÃ­as, para usar, reproducir, modificar y mostrar tu reseÃ±a en conexiÃ³n con la Plataforma y la promociÃ³n de nuestros productos.

Eres responsable del contenido de tus reseÃ±as. No deben contener lenguaje ofensivo, difamatorio, ilegal o inapropiado.

Nos reservamos el derecho de moderar o eliminar reseÃ±as que violen estos TÃ©rminos o que consideremos inapropiadas, sin previo aviso.

Puedes gestionar tus favoritos y reseÃ±as desde la secciÃ³n "Mi Actividad".

8. Privacidad y Datos Personales

Recopilamos y utilizamos tu informaciÃ³n personal (nombre, nÃºmero de telÃ©fono, direcciones, historial de pedidos, favoritos, reseÃ±as) para operar la Plataforma, procesar tus pedidos, mejorar nuestro servicio y comunicarnos contigo.

Utilizamos tu nÃºmero de WhatsApp como identificador principal y para comunicaciones relacionadas con tus pedidos y el servicio.

Podemos utilizar cookies o tecnologÃ­as similares para el funcionamiento de la Plataforma y mejorar tu experiencia.

9. ComunicaciÃ³n

Al registrarte, aceptas recibir comunicaciones de nuestra parte a travÃ©s de WhatsApp relacionadas con tus pedidos (confirmaciones, actualizaciones, solicitudes de cancelaciÃ³n) y potencialmente otras notificaciones sobre el servicio o promociones.

Si tu navegador lo permite y otorgas permiso, podrÃ­amos enviarte notificaciones push sobre actualizaciones importantes o promociones. Puedes gestionar estos permisos en la configuraciÃ³n de tu navegador o dispositivo.

10. Propiedad Intelectual

Todo el contenido de la Plataforma, incluyendo textos, grÃ¡ficos, logos, imÃ¡genes y software, es propiedad de Entre Alas o sus licenciantes y estÃ¡ protegido por las leyes de propiedad intelectual. No puedes copiar, modificar, distribuir o utilizar dicho contenido sin nuestro permiso explÃ­cito por escrito.

11. LimitaciÃ³n de Responsabilidad y Descargos de GarantÃ­a

La Plataforma se proporciona "tal cual" y "segÃºn disponibilidad". No garantizamos que la Plataforma estÃ© libre de errores o interrupciones.

Alergias e Intolerancias: Es tu responsabilidad informarnos sobre cualquier alergia o intolerancia alimentaria al momento de realizar tu pedido (preferiblemente en el mensaje de confirmaciÃ³n de WhatsApp, o contactÃ¡ndonos directamente). Aunque tomamos precauciones, no podemos garantizar la ausencia total de alÃ©rgenos en nuestros productos o cocina. No nos hacemos responsables por reacciones alÃ©rgicas si no fuiste explÃ­cito sobre tus restricciones.

En la mÃ¡xima medida permitida por la ley, Entre Alas no serÃ¡ responsable por daÃ±os directos, indirectos, incidentales, especiales o consecuentes que resulten del uso o la imposibilidad de usar la Plataforma o el Servicio.

Nuestra responsabilidad total por cualquier reclamo relacionado con un pedido se limitarÃ¡ al monto pagado por dicho pedido.

12. Modificaciones a los TÃ©rminos

Nos reservamos el derecho de modificar estos TÃ©rminos en cualquier momento. Publicaremos los TÃ©rminos actualizados en la Plataforma. Se te podrÃ¡ solicitar que aceptes los nuevos tÃ©rminos para continuar utilizando el Servicio. Es tu responsabilidad revisar los TÃ©rminos periÃ³dicamente.

13. Contacto

Si tienes alguna pregunta sobre estos TÃ©rminos y Condiciones, por favor contÃ¡ctanos a travÃ©s de 9631834700 o contacto.entrealas@gmail.com.


// supabase/functions/send-order-notification/index.ts
import { createClient } from 'npm:@supabase/supabase-js@2';
// === 1ï¸âƒ£ Variables de entorno ===
const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
const FCM_SERVER_KEY = Deno.env.get('FCM_SERVER_KEY'); // ðŸ”¥ NUEVA CLAVE
if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY || !FCM_SERVER_KEY) {
  console.error('âŒ Missing environment variables.');
  Deno.exit(1);
}
console.log('ðŸš€ Edge Function initialized: send-order-notification');
// === FunciÃ³n para eliminar suscripciÃ³n invÃ¡lida ===
async function deleteInvalidSubscription(supabase, endpoint) {
  console.warn(`ðŸ—‘ï¸ Deleting invalid subscription with endpoint: ${endpoint}`);
  const { error: deleteError } = await supabase.from('push_subscriptions').delete().eq('subscription_token->>endpoint', endpoint); // Usar el endpoint completo para asegurar unicidad
  if (deleteError) {
    console.error(`âŒ Failed to delete subscription ${endpoint}:`, deleteError.message);
  } else {
    console.log(`âœ… Successfully deleted subscription ${endpoint}.`);
  }
}
// === 2ï¸âƒ£ FunciÃ³n principal ===
Deno.serve(async (req)=>{
  try {
    const payload = await req.json();
    console.log('ðŸ“¦ Received payload:', JSON.stringify(payload, null, 2));
    const order = payload.record;
    const oldOrder = payload.old_record;
    if (!order || !order.customer_id) {
      throw new Error('Invalid order data in payload.');
    }
    // Solo notificar si el estado cambiÃ³ realmente
    if (oldOrder && order.status === oldOrder.status) {
      console.log(`â„¹ï¸ Order ${order.order_code} status did not change. Skipping.`);
      return new Response('Status did not change', {
        status: 200
      });
    }
    console.log(`ðŸ”” Order ${order.order_code} status changed to ${order.status}. Fetching subscriptions...`);
    // Crear cliente Supabase dentro del handler
    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
    const { data: subscriptions, error } = await supabase.from('push_subscriptions').select('subscription_token') // Solo necesitamos el token
    .eq('customer_id', order.customer_id);
    if (error) throw error;
    if (!subscriptions || subscriptions.length === 0) {
      console.warn(`âš ï¸ No push subscriptions found for customer: ${order.customer_id}`);
      return new Response('No subscriptions found', {
        status: 200
      });
    }
    console.log(`âœ… Found ${subscriptions.length} subscription(s). Sending via FCM...`);
    // Mensajes segÃºn estado
    const statusMessages = {
      en_proceso: 'Tu pedido estÃ¡ en proceso.',
      en_envio: 'Â¡Tu pedido ya va en camino!',
      completado: 'Tu pedido ha sido completado. Â¡Gracias por tu compra!',
      cancelado: 'Tu pedido ha sido cancelado.'
    };
    const notificationData = {
      title: `ActualizaciÃ³n de pedido #${order.order_code}`,
      body: statusMessages[order.status] || `Estado: ${order.status}`
    };
    const dataPayload = {
      url: '/mis-pedidos' // URL a abrir al hacer clic
    };
    // === 3ï¸âƒ£ Enviar notificaciones y manejar errores ===
    const sendPromises = subscriptions.map(async ({ subscription_token })=>{
      const endpoint = subscription_token?.endpoint; // Safely access endpoint
      const fcmToken = subscription_token?.keys?.auth; // O usa el campo correcto donde guardas el token si es diferente
      if (!endpoint || !fcmToken) {
        console.warn('âš ï¸ Invalid subscription object:', subscription_token);
        return; // Skip this subscription
      }
      try {
        const fcmResponse = await fetch('https://fcm.googleapis.com/fcm/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `key=${FCM_SERVER_KEY}`
          },
          body: JSON.stringify({
            to: fcmToken,
            notification: notificationData,
            data: dataPayload // EnvÃ­a datos adicionales aquÃ­
          })
        });
        // --- ðŸ‘‡ MANEJO DE RESPUESTA DE FCM ---
        if (!fcmResponse.ok) {
          // Si la respuesta NO fue exitosa (ej. 404, 410, etc.)
          const status = fcmResponse.status;
          const responseText = await fcmResponse.text(); // Leer el cuerpo para logs
          console.error(`âŒ FCM error for token ${fcmToken} (Endpoint: ${endpoint}) - Status: ${status}, Response: ${responseText}`);
          // Si el error es 404 (Not Found) o 410 (Gone), el token es invÃ¡lido
          if (status === 404 || status === 410) {
            await deleteInvalidSubscription(supabase, endpoint);
          }
        } else {
          // Si la respuesta fue exitosa (ej. 200 OK)
          const responseJson = await fcmResponse.json(); // FCM suele devolver JSON en Ã©xito
          console.log(`ðŸ“¨ FCM success for ${fcmToken} (Endpoint: ${endpoint}):`, JSON.stringify(responseJson));
        }
      // --- ðŸ‘† FIN MANEJO DE RESPUESTA ---
      } catch (fetchError) {
        // Error al intentar contactar FCM (problema de red, etc.)
        console.error(`ðŸ’¥ Network or fetch error sending to ${endpoint}:`, fetchError.message);
      }
    });
    await Promise.all(sendPromises); // Esperar a que todos los envÃ­os terminen
    console.log('âœ… Push notification sending process completed.');
    return new Response(JSON.stringify({
      success: true
    }), {
      headers: {
        'Content-Type': 'application/json'
      }
    });
  } catch (error) {
    console.error('ðŸ’¥ General Error in Edge Function:', error.message);
    return new Response(JSON.stringify({
      error: error.message
    }), {
      status: 500,
      headers: {
        'Content-Type': 'application/json'
      }
    });
  }
});


podemos hacer que en notificationManager.jsx inicialice el sdk de firebase asi no tendremos problemas en el futuro si queremos escalar la app

-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.admins (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  email character varying NOT NULL UNIQUE,
  role USER-DEFINED DEFAULT 'staff'::admin_role,
  created_at timestamp with time zone DEFAULT now(),
  permissions jsonb DEFAULT '{"dashboard": true}'::jsonb,
  CONSTRAINT admins_pkey PRIMARY KEY (id),
  CONSTRAINT fk_admins_auth_users FOREIGN KEY (id) REFERENCES auth.users(id)
);
CREATE TABLE public.business_exceptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  start_date date NOT NULL UNIQUE,
  is_closed boolean DEFAULT true,
  open_time time without time zone,
  close_time time without time zone,
  reason text,
  created_at timestamp with time zone DEFAULT now(),
  end_date date,
  CONSTRAINT business_exceptions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.business_hours (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  day_of_week smallint NOT NULL UNIQUE CHECK (day_of_week >= 0 AND day_of_week <= 6),
  open_time time without time zone NOT NULL,
  close_time time without time zone NOT NULL,
  is_closed boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT business_hours_pkey PRIMARY KEY (id)
);
CREATE TABLE public.categories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT categories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.customer_addresses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_id uuid NOT NULL,
  label character varying NOT NULL,
  latitude numeric NOT NULL,
  longitude numeric NOT NULL,
  address text,
  address_reference text,
  created_at timestamp with time zone DEFAULT now(),
  is_default boolean DEFAULT false,
  CONSTRAINT customer_addresses_pkey PRIMARY KEY (id),
  CONSTRAINT customer_addresses_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_discount_usage (
  customer_id uuid NOT NULL,
  discount_id uuid NOT NULL,
  used_at timestamp with time zone DEFAULT now(),
  CONSTRAINT customer_discount_usage_pkey PRIMARY KEY (customer_id, discount_id),
  CONSTRAINT customer_discount_usage_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_discount_usage_discount_id_fkey FOREIGN KEY (discount_id) REFERENCES public.discounts(id)
);
CREATE TABLE public.customer_favorites (
  customer_id uuid NOT NULL,
  product_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT customer_favorites_pkey PRIMARY KEY (customer_id, product_id),
  CONSTRAINT customer_favorites_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_favorites_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id)
);
CREATE TABLE public.customer_reward_claims (
  customer_id uuid NOT NULL,
  reward_id uuid NOT NULL,
  claimed_at timestamp with time zone DEFAULT now(),
  generated_code text NOT NULL,
  CONSTRAINT customer_reward_claims_pkey PRIMARY KEY (customer_id, reward_id),
  CONSTRAINT customer_reward_claims_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_reward_claims_reward_id_fkey FOREIGN KEY (reward_id) REFERENCES public.rewards(id)
);
CREATE TABLE public.customer_terms_acceptances (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_id uuid NOT NULL,
  terms_version_id uuid NOT NULL,
  accepted_at timestamp with time zone DEFAULT now(),
  CONSTRAINT customer_terms_acceptances_pkey PRIMARY KEY (id),
  CONSTRAINT customer_terms_acceptances_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_terms_acceptances_terms_version_id_fkey FOREIGN KEY (terms_version_id) REFERENCES public.terms_and_conditions(id)
);
CREATE TABLE public.customers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  phone character varying NOT NULL UNIQUE,
  created_at timestamp with time zone DEFAULT now(),
  referral_code character varying UNIQUE,
  referrer_id uuid,
  referral_count integer DEFAULT 0,
  has_made_first_purchase boolean DEFAULT false,
  CONSTRAINT customers_pkey PRIMARY KEY (id),
  CONSTRAINT customers_referrer_id_fkey FOREIGN KEY (referrer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.discounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code character varying NOT NULL UNIQUE,
  type USER-DEFINED NOT NULL,
  value numeric NOT NULL CHECK (value >= 0::numeric),
  target_id uuid,
  start_date date,
  end_date date,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  is_single_use boolean DEFAULT false,
  requires_referred_status boolean DEFAULT false,
  specific_customer_id uuid,
  CONSTRAINT discounts_pkey PRIMARY KEY (id),
  CONSTRAINT discounts_specific_customer_id_fkey FOREIGN KEY (specific_customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.order_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_id uuid NOT NULL,
  product_id uuid NOT NULL,
  quantity integer NOT NULL CHECK (quantity > 0),
  price numeric NOT NULL CHECK (price >= 0::numeric),
  cost numeric NOT NULL DEFAULT 0 CHECK (cost >= 0::numeric),
  CONSTRAINT order_items_pkey PRIMARY KEY (id),
  CONSTRAINT order_items_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_items_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id)
);
CREATE TABLE public.orders (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_code character varying NOT NULL UNIQUE,
  customer_id uuid NOT NULL,
  status USER-DEFINED DEFAULT 'pendiente'::order_status,
  total_amount numeric NOT NULL CHECK (total_amount >= 0::numeric),
  discount_code character varying,
  cancellation_reason text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  scheduled_for timestamp with time zone,
  CONSTRAINT orders_pkey PRIMARY KEY (id),
  CONSTRAINT orders_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT orders_discount_code_fkey FOREIGN KEY (discount_code) REFERENCES public.discounts(code)
);
CREATE TABLE public.product_images (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id uuid NOT NULL,
  image_url text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_images_pkey PRIMARY KEY (id),
  CONSTRAINT product_images_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id)
);
CREATE TABLE public.product_reviews (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id uuid NOT NULL,
  customer_id uuid NOT NULL,
  rating smallint NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_reviews_pkey PRIMARY KEY (id),
  CONSTRAINT product_reviews_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT product_reviews_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.products (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  description text,
  price numeric NOT NULL CHECK (price >= 0::numeric),
  cost numeric NOT NULL CHECK (cost >= 0::numeric),
  image_url text,
  category_id uuid NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT products_pkey PRIMARY KEY (id),
  CONSTRAINT products_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.categories(id)
);
CREATE TABLE public.push_subscriptions (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  customer_id uuid NOT NULL UNIQUE,
  subscription_token text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT push_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT push_subscriptions_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.referral_levels (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  min_referrals integer NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT referral_levels_pkey PRIMARY KEY (id)
);
CREATE TABLE public.rewards (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  level_id uuid,
  description text NOT NULL,
  type character varying,
  reward_code character varying,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT rewards_pkey PRIMARY KEY (id),
  CONSTRAINT rewards_level_id_fkey FOREIGN KEY (level_id) REFERENCES public.referral_levels(id)
);
CREATE TABLE public.settings (
  key text NOT NULL,
  value jsonb,
  description text,
  CONSTRAINT settings_pkey PRIMARY KEY (key)
);
CREATE TABLE public.special_prices (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id uuid,
  category_id uuid,
  override_price numeric NOT NULL CHECK (override_price >= 0::numeric),
  start_date date NOT NULL,
  end_date date NOT NULL,
  reason text,
  created_at timestamp with time zone DEFAULT now(),
  target_customer_ids ARRAY,
  CONSTRAINT special_prices_pkey PRIMARY KEY (id),
  CONSTRAINT special_prices_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT special_prices_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.categories(id)
);
CREATE TABLE public.terms_and_conditions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  version integer NOT NULL UNIQUE,
  content text NOT NULL,
  published_at timestamp with time zone DEFAULT now(),
  CONSTRAINT terms_and_conditions_pkey PRIMARY KEY (id)
);